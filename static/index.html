<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Student CRUD Client</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .form-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .form-card:hover {
            transform: translateY(-2px);
        }
        .input-field {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .login-card {
            max-width: 400px;
            margin: 10vh auto;
            padding: 2rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Login Form Container -->
    <div id="loginContainer" class="login-card">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">Admin Login</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">Enter credentials to access the Student Portal.</p>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="username" placeholder="Enter Username" class="input-field" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" placeholder="Enter Password" class="input-field" required>
            </div>
            <div id="loginMessage" class="text-sm text-red-600 hidden"></div>
            <button type="submit" id="loginBtn" class="btn-primary w-full mt-4">Login</button>
        </form>
    </div>

    <!-- Main Application Content (Initially Hidden) -->
    <div id="mainContent" class="hidden max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Student Database Manager</h1>
        <p class="text-lg text-gray-600 mb-4">FastAPI Backend Client for PostgreSQL CRUD Operations.</p>
        
        <div id="messages" class="mb-6 p-4 rounded-lg hidden" role="alert"></div>
        
        <!-- Search/Read Single Student -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 form-card mb-8">
            <h2 class="text-2xl font-bold text-blue-700 mb-4">Search Student by ID (GET /students/db/{id})</h2>
            <form id="searchForm" class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                <input type="number" id="searchId" placeholder="Enter Student ID to Search (e.g., 101)" class="input-field flex-grow" required>
                <button type="submit" id="searchBtn" class="btn-primary bg-blue-600 hover:bg-blue-700">Search Student</button>
            </form>
            <div id="searchResult" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <p class="font-semibold text-blue-800">Result:</p>
                <code id="searchCode" class="block whitespace-pre-wrap text-sm text-blue-700"></code>
            </div>
            <div id="searchError" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden text-sm text-red-700"></div>
        </div>
        <!-- End Search/Read Single Student -->

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <!-- CREATE/INSERT CARD -->
            <div class="form-card bg-white p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">1. Insert Student (POST /students/db/insert)</h2>
                <form id="insertForm" class="space-y-4">
                    <input type="number" id="insertId" placeholder="Student ID (e.g., 101)" class="input-field" required>
                    <input type="text" id="insertName" placeholder="Name" class="input-field" required>
                    <input type="number" id="insertAge" placeholder="Age" class="input-field" required>
                    <button type="submit" id="insertBtn" class="btn-primary w-full">Insert Student</button>
                </form>
            </div>

            <!-- UPDATE CARD -->
            <div class="form-card bg-white p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-yellow-700 mb-4">2. Update Student (PUT /students/db/update)</h2>
                <form id="updateForm" class="space-y-4">
                    <input type="number" id="updateId" placeholder="Student ID to Update" class="input-field" required>
                    <input type="text" id="updateName" placeholder="New Name" class="input-field" required>
                    <input type="number" id="updateAge" placeholder="New Age" class="input-field" required>
                    <button type="submit" id="updateBtn" class="btn-primary w-full bg-yellow-600 hover:bg-yellow-700">Update Student</button>
                </form>
            </div>

            <!-- DELETE CARD -->
            <div class="form-card bg-white p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold text-red-700 mb-4">3. Delete Student (DELETE /students/db/update/{id})</h2>
                <form id="deleteForm" class="space-y-4">
                    <input type="number" id="deleteId" placeholder="Student ID to Delete" class="input-field" required>
                    <button type="submit" id="deleteBtn" class="btn-primary w-full bg-red-600 hover:bg-red-700">Delete Student</button>
                </form>
            </div>
        </div>

        <!-- READ/DISPLAY ALL SECTION - This is where the student array is displayed -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 form-card">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">All Student Records (GET /students/db)</h2>
            <button onclick="fetchStudents()" class="btn-primary mb-4 bg-gray-500 hover:bg-gray-600">Refresh Student List</button>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Student data will be inserted here by fetchStudents() -->
                        <tr>
                            <td colspan="3" class="px-6 py-4 text-center text-gray-500">Log in to view student data.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // NOTE: This URL must be updated to your current ngrok HTTPS URL (e.g., "https://abcdefg.ngrok-free.app")
        const API_BASE_URL = " http://127.0.0.1:8000"; 
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Authentication Credentials ---
            const ADMIN_USER = "admin";
            const ADMIN_PASS = "sd_123";

            // --- DOM Elements ---
            const loginContainer = document.getElementById('loginContainer');
            const loginForm = document.getElementById('loginForm');
            const loginMessage = document.getElementById('loginMessage');
            const mainContent = document.getElementById('mainContent');
            const messagesDiv = document.getElementById('messages');
            const studentTableBody = document.getElementById('studentTableBody');
            const searchForm = document.getElementById('searchForm');
            const searchBtn = document.getElementById('searchBtn');
            const searchResultDiv = document.getElementById('searchResult');
            const searchCode = document.getElementById('searchCode');
            const searchErrorDiv = document.getElementById('searchError');
            const insertBtn = document.getElementById('insertBtn');
            const updateBtn = document.getElementById('updateBtn');
            const deleteBtn = document.getElementById('deleteBtn');


            /**
             * Utility function to display success or error messages to the user (main app).
             * @param {string} message - The message content.
             * @param {string} type - 'success' or 'error'.
             */
            function showMessage(message, type) {
                messagesDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'border-green-400', 'border-red-400');
                messagesDiv.textContent = message;

                if (type === 'success') {
                    messagesDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
                } else if (type === 'error') {
                    messagesDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
                }
                setTimeout(() => {
                    messagesDiv.classList.add('hidden');
                }, 5000);
            }
            
            /**
             * Fetches resources with exponential backoff and retry logic for network errors.
             * @param {string} url - The API endpoint URL.
             * @param {object} options - Fetch options (method, headers, body, etc.).
             * @param {number} maxRetries - Maximum number of retries.
             * @param {number} delay - Initial delay in milliseconds.
             * @returns {Promise<Response>} The fetch response object.
             * @throws {Error} If all retries fail due to a network error.
             */
            async function fetchWithRetry(url, options = {}, maxRetries = 3, delay = 1000) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        // We return the response even if not response.ok, so the caller can handle 4xx/5xx errors
                        return response; 
                    } catch (error) {
                        // This catches network/CORS errors (e.g., connection refused, timeout).
                        if (i === maxRetries - 1) {
                            // Last attempt failed, throw the network error
                            throw new Error(`Failed to connect to API at ${API_BASE_URL}. Ensure ngrok and FastAPI are running.`);
                        }
                        // Exponential Backoff: Wait for delay * 2^i milliseconds before retrying
                        const sleepTime = delay * (2 ** i);
                        console.warn(`Fetch failed (attempt ${i + 1}/${maxRetries}). Retrying in ${sleepTime}ms...`);
                        await new Promise(resolve => setTimeout(resolve, sleepTime));
                    }
                }
            }


            // --- Authentication Logic ---

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === ADMIN_USER && password === ADMIN_PASS) {
                    // Successful Login
                    loginContainer.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    // Fetch data immediately after successful login
                    fetchStudents(); 
                } else {
                    // Failed Login
                    loginMessage.textContent = "Invalid username or password.";
                    loginMessage.classList.remove('hidden');
                    // Clear password field for security
                    document.getElementById('password').value = ''; 
                    setTimeout(() => {
                        loginMessage.classList.add('hidden');
                    }, 3000);
                }
            });


            // --- Search/Read Single Student Logic ---
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<span class="spinner"></span>Searching...';

                const studentId = document.getElementById('searchId').value;
                
                // Clear previous results
                searchResultDiv.classList.add('hidden');
                searchErrorDiv.classList.add('hidden');
                searchErrorDiv.textContent = '';
                searchCode.textContent = '';

                if (!studentId) {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Search Student';
                    return;
                }

                try {
                    // Using GET /students/db/{id} endpoint with retry
                    const response = await fetchWithRetry(`${API_BASE_URL}/students/db/${studentId}`);
                    
                    const result = await response.json();

                    if (!response.ok) {
                        // FastAPI returns 404/422/500 with JSON containing a 'detail' field for errors
                        throw new Error(result.message || result.detail || `HTTP error! Status: ${response.status}`);
                    }
                    
                    // Check for custom backend message if not record was found
                    if (result.message) {
                        throw new Error(result.message);
                    }

                    searchCode.textContent = JSON.stringify(result, null, 2);
                    searchResultDiv.classList.remove('hidden');
                } catch (error) {
                    console.error("Search error:", error);
                    searchErrorDiv.textContent = error.message;
                    searchErrorDiv.classList.remove('hidden');
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Search Student';
                }
            });


            // --- CRUD/API Logic ---

            /**
             * Fetches all students and populates the table. Uses GET /students/db
             */
            window.fetchStudents = async function() {
                // Check if content is visible (i.e., user is logged in)
                if (mainContent.classList.contains('hidden')) {
                    studentTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Please log in to view data.</td></tr>';
                    return;
                }

                studentTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500"><span class="spinner"></span>Fetching data...</td></tr>';
                try {
                    // Using the new endpoint /students/db with retry
                    const response = await fetchWithRetry(`${API_BASE_URL}/students/db`);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }
                    
                    const students = await response.json();
                    
                    if (students.length === 0) {
                        // Improved visual feedback for empty state
                        studentTableBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500 bg-gray-50 italic">No student records found in the database. Insert one above!</td></td></tr>';
                        return;
                    }

                    // Map the array of student objects to HTML table rows
                    studentTableBody.innerHTML = students.map(student => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.age}</td>
                        </tr>
                    `).join('');
                    
                } catch (error) {
                    console.error("Fetch error:", error);
                    // Show a specific error message if the fetch failed due to connectivity
                    studentTableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error fetching data: ${error.message}</td></tr>`;
                    showMessage(`Could not load students: ${error.message}`, 'error');
                }
            }

            /**
             * Handles form submission for inserting a student (POST /students/db/insert).
             */
            document.getElementById('insertForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                insertBtn.disabled = true;
                insertBtn.textContent = 'Inserting...';

                const studentData = {
                    id: parseInt(document.getElementById('insertId').value),
                    name: document.getElementById('insertName').value,
                    age: parseInt(document.getElementById('insertAge').value)
                };

                try {
                    const response = await fetchWithRetry(`${API_BASE_URL}/students/db/insert`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(studentData)
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || result.message || "Failed to insert student.");
                    }

                    showMessage(result.message, 'success');
                    e.target.reset();
                    fetchStudents(); // Refresh the list
                } catch (error) {
                    console.error("Insert error:", error);
                    showMessage(`Insert failed: ${error.message}`, 'error');
                } finally {
                    insertBtn.disabled = false;
                    insertBtn.textContent = 'Insert Student';
                }
            });

            /**
             * Handles form submission for updating a student (PUT /students/db/update).
             */
            document.getElementById('updateForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                updateBtn.disabled = true;
                updateBtn.textContent = 'Updating...';

                const studentData = {
                    id: parseInt(document.getElementById('updateId').value),
                    name: document.getElementById('updateName').value,
                    age: parseInt(document.getElementById('updateAge').value)
                };

                try {
                    const response = await fetchWithRetry(`${API_BASE_URL}/students/db/update`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(studentData)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || result.message || "Failed to update student.");
                    }

                    showMessage(result.message, 'success');
                    e.target.reset();
                    fetchStudents(); // Refresh the list
                } catch (error) {
                    console.error("Update error:", error);
                    showMessage(`Update failed: ${error.message}`, 'error');
                } finally {
                    updateBtn.disabled = false;
                    updateBtn.textContent = 'Update Student';
                }
            });

            /**
             * Handles form submission for deleting a student (DELETE /students/db/update/{id}).
             */
            document.getElementById('deleteForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                
                const studentId = document.getElementById('deleteId').value;
                
                try {
                    // Using the user-defined path for DELETE: /students/db/update/{id}
                    const response = await fetchWithRetry(`${API_BASE_URL}/students/db/update/${studentId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || result.message || "Failed to delete student.");
                    }

                    showMessage(result.message, 'success');
                    e.target.reset();
                    fetchStudents(); // Refresh the list
                } catch (error) {
                    console.error("Delete error:", error);
                    showMessage(`Delete failed: ${error.message}`, 'error');
                } finally {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'Delete Student';
                }
            });
            
        });
    </script>
</body>
</html>